<!DOCTYPE html>
<html lang="en" data-theme="lofi">
<head>
    <meta charset="UTF-8">
    <title>Register - The Glow Salon</title>
    <link rel="stylesheet" href="/css/output.css">
    <!-- htmx and json-enc extension for sending form data as JSON -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>

    <!-- Tailwind CSS + DaisyUI CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />

</head>
<body class="min-h-screen bg-base-200 flex items-center justify-center">
<div class="card w-96 bg-base-100 shadow-xl">
    <div class="card-body">
        <h2 class="card-title justify-center text-2xl mb-4">Register for The Glow Salon</h2>

        <div id="register-error" class="alert alert-error mb-4 hidden">
            <span id="error-message"></span>
        </div>

        <!-- Added hx-ext="json-enc" to send as JSON, and hx-swap="none" to avoid swap issues on error/success -->
        <form id="register-form" hx-post="/api/auth/register" hx-ext="json-enc" hx-swap="none">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">First Name</span>
                </label>
                <input type="text" name="firstName" placeholder="Enter first name" class="input input-bordered" required>
            </div>

            <div class="form-control mt-4">
                <label class="label">
                    <span class="label-text">Last Name</span>
                </label>
                <input type="text" name="lastName" placeholder="Enter last name" class="input input-bordered" required>
            </div>

            <div class="form-control mt-4">
                <label class="label">
                    <span class="label-text">Email</span>
                </label>
                <input type="email" name="email" placeholder="Enter email" class="input input-bordered" required>
            </div>

            <div class="form-control mt-4">
                <label class="label">
                    <span class="label-text">Phone</span>
                </label>
                <input type="tel" name="phone" placeholder="Enter phone" class="input input-bordered" required>
            </div>

            <div class="form-control mt-4">
                <label class="label">
                    <span class="label-text">Password</span>
                </label>
                <input type="password" name="password" placeholder="Enter password" class="input input-bordered" required>
            </div>

            <div class="form-control mt-6">
                <button type="submit" class="btn btn-primary w-full">Register</button>
            </div>
        </form>

        <div id="register-response"></div>

        <div class="text-center mt-4">
            <p class="text-sm">
                Already have an account? <a href="/login" class="link link-primary">Login</a>
            </p>
        </div>
    </div>
</div>

<script>
    const errorDiv = document.getElementById('register-error');
    const errorTextSpan = document.getElementById('error-message');

    // Handle API Response
    document.body.addEventListener('htmx:afterRequest', function(e) {
        if (e.detail.xhr.status === 200) {
            // Registration succeeded - now auto-login by posting to /api/auth/login
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');

            htmx.ajax('POST', '/api/auth/login', {
                values: { email, password },
                headers: { 'Content-Type': 'application/json' },  // Ensure JSON for login too
                target: '#register-response',
                swap: 'none'
            }).then(function(loginResponse) {
                if (loginResponse.status === 200) {
                    // Login succeeded - extract token from cookie or response, then redirect
                    const token = document.cookie.split('; ').find(row => row.startsWith('jwt=')).split('=')[1];
                    if (token) {
                        localStorage.setItem('token', token);
                    }
                    window.location.href = '/dashboard';
                } else {
                    errorTextSpan.textContent = 'Registration succeeded, but login failed. Please log in manually.';
                    errorDiv.classList.remove('hidden');
                }
            });
        } else if (e.detail.xhr.status === 400 || e.detail.xhr.status === 500) {
            try {
                const errorJson = JSON.parse(e.detail.xhr.responseText);
                const details = errorJson.details || {};
                let errorMsg = errorJson.message || 'Registration failed';

                // If validation errors, show field-specific messages
                if (Object.keys(details).length > 0) {
                    errorMsg = Object.entries(details).map(([field, msg]) => `${field}: ${msg}`).join(', ');
                }
                errorTextSpan.textContent = errorMsg;
            } catch {
                errorTextSpan.textContent = 'Registration failed: Invalid data or email exists';
            }
            errorDiv.classList.remove('hidden');
        }
    });

    // Clear error on input
    document.getElementById('register-form').addEventListener('input', function() {
        if (!errorDiv.classList.contains('hidden')) {
            errorDiv.classList.add('hidden');
        }
    });
</script>
</body>
</html>